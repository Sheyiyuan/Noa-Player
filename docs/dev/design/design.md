# Noa Studio — 设计文档（Design Doc / Local-First Edition）
版本：v0.5-local-first  
状态：Draft  
更新日期：2026-02-18  
目标：定义三栏固定工作台、多屏显示模式、时间戳/AB/截图/GIF/OCR/Markdown 联动的实现方案。

---

## 1. 设计原则
- **单任务高聚焦**：观看、提取、记录在同一窗口完成。
- **最小心智负担**：自动归档、自动保存、自动插入，用户少做路径管理。
- **本地文件透明**：工程结构可直接在文件系统查看与迁移。
- **MVP 优先**：先保证截图与笔记主链路稳定，再扩展 GIF、多屏高级模式与 AI 深化。

---

## 2. 窗口与布局交互
### 2.1 主窗口（三栏固定）
- 左栏（播放器区）
  - 视频画面
  - 控制条：播放/暂停、进度、音量、倍速、全屏
  - 时间戳显示
  - AB 操作：设置 A、设置 B、取消循环
  - 采集入口：截图、GIF 录制
- 中栏（资源库）
  - 素材列表：截图、GIF、OCR 文本、本地图片
  - 交互：预览、放大查看、拖拽到笔记、重命名、删除
  - 排序：按时间戳、按文件类型
- 右栏（Markdown 编辑器）
  - 极简编辑（基础 Markdown）
  - 快捷插入：时间戳、AB 标记、图片/GIF
  - 自动保存与崩溃恢复

### 2.2 多屏专业模式
- 主窗口保留所有交互控制。
- 独立视频窗口仅显示画面（无边框、无控件、可全屏）。
- 支持悬浮小窗模式：置顶 + 点击穿透。
- 副屏窗口不应抢焦点，不应改变主窗口的控制上下文。

---

## 3. 功能模块设计
### 3.1 播放模块
- 输入源：本地文件、视频直链。
- 状态：`currentTime`、`duration`、`rate`、`volume`、`isLoopAB`。
- 输出事件：时间更新、源加载成功/失败、循环区间状态变化。

### 3.2 AB 复读模块
- 数据结构：`abSegment = { aMs, bMs, enabled }`。
- 交互逻辑：
  1) 点击 A 记录当前时间。
  2) 点击 B 记录当前时间并启用循环。
  3) 播放超出 B 自动 seek 到 A。
  4) 点击取消立即关闭循环。
- 与笔记联动：生成 `[AB mm:ss-mm:ss]` 标记，点击触发循环激活。

### 3.3 时间戳系统
- 插入格式：`[hh:mm:ss]`。
- 点击行为：解析标记并调用播放器 seek。
- 素材元数据：截图/GIF 自动写入 `timestampMs` 与可读标签。

### 3.4 截图与 GIF 模块
- 截图（MVP 主链路）
  - 从当前视频帧生成图片
  - 自动落盘到工程 `assets/`
  - 自动生成资源条目并插入笔记
- GIF（后续迭代）
  - 录制模式：手动开始/结束、基于 AB 片段
  - 处理引擎：`ffmpeg.wasm`
  - 输出与截图统一进入资源库

### 3.5 笔记编辑器模块
- 范围限定：仅基础 Markdown，不含复杂排版/表格/公式/导出排版。
- 文件格式：标准 `.md`。
- 编辑能力：文本输入、图片/GIF 拖拽、时间戳/AB 快捷插入。
- 保存策略：本地自动保存（防抖 + 退出前 flush）。

### 3.6 资源库模块
- 资源类型：`screenshot | gif | image | ocr-text`。
- 核心能力：预览、拖拽插入、重命名、删除、排序。
- 绑定关系：单工程资源集，不跨工程共享默认索引。

### 3.7 AI 增强模块（可选）
- 配置：用户在本地填写 API Key 与 base URL/model。
- 功能：OCR 结果整理、选中文本总结/翻译、生成笔记大纲。
- 约束：AI 调用失败不影响核心链路，且可完全禁用。

---

## 4. 工程文件模型（本地优先）
### 4.1 目录结构
```text
project-folder/
  note.md
  assets/
    20260218-012345.png
    20260218-012520.gif
    imported-xxx.jpg
```

### 4.2 规则
- 一个工程 = 一个普通文件夹。
- 笔记为标准 Markdown 文件；素材统一在 `assets/`。
- 不额外引入必须存在的配置文件。
- 可直接复制、备份、分享。

---

## 5. IPC 边界与接口草案
### 5.1 安全基线
- `contextIsolation: true`
- `nodeIntegration: false`
- Renderer 仅通过 preload 白名单调用系统能力

### 5.2 关键通道
- `playback.open(source)`
- `playback.control({ action, value })`
- `playback.setAB({ aMs, bMs, enabled })`
- `capture.screenshot()`
- `capture.recordGif({ startMs, endMs })`
- `library.list(projectId)` / `library.rename(id, name)` / `library.delete(id)`
- `note.insertToken({ type: 'timestamp' | 'ab' | 'asset', payload })`
- `note.save({ path, content })`
- `ocr.run(assetId)`
- `ai.run({ task, text, provider })`

---

## 6. 关键流程
### 6.1 截图一体化流程（MVP）
1) 用户在左栏点击截图。  
2) 播放器提取当前帧并落盘至 `assets/`。  
3) 资源库新增条目（携带时间戳）。  
4) 右栏笔记自动插入图片引用与时间戳。  
5) 自动保存笔记。

### 6.2 时间戳回跳流程
1) 在笔记插入 `[hh:mm:ss]`。  
2) 点击标记后解析到毫秒。  
3) 左栏播放器跳转并继续播放。

### 6.3 AB 复读流程（v0.2）
1) 标记 A 点。  
2) 标记 B 点并开启循环。  
3) 到达 B 后自动跳回 A。  
4) 取消循环后恢复普通播放。

### 6.4 GIF 录制流程（v0.2）
1) 选择开始/结束或直接读取 AB 区间。  
2) 调用 `ffmpeg.wasm` 生成 GIF。  
3) 自动入库并插入笔记。

---

## 7. 非目标与约束
- 当前阶段不实现复杂编辑器能力（表格、公式、版式系统）。
- 当前阶段不实现云同步、账号、服务端转码。
- AI 与插件能力均不阻塞核心本地工作流。

---

## 8. 测试重点
- 三栏布局在常见分辨率下稳定展示。
- 截图→入库→插入笔记链路正确。
- 自动保存在异常关闭后可恢复。
- 时间戳与 AB 标记点击行为正确。
- 多屏模式下副屏不抢焦点、主控制持续可用。

---

## 9. 与路线图对齐
- MVP：三栏 + 播放 + 时间戳 + 截图 + 资源库 + 极简编辑器 + 工程文件夹 + OCR。
- Iteration：GIF、AB 增强、多屏增强、AI 增强、插件与生态能力。
